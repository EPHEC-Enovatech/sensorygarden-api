language: ruby
rvm:
- 2.5.1
bundler_args: "--jobs=2"
cache: bundler
services:
- mysql
env:
  secure: Jy6m6ya+5Duum/ovI0UZhfVuNZJAXBV0M83gOxNabwcQQd5n3Z9FXhbFdvEm7bPitGL4x5eu+sBEwd5C1TMNQU5FPe7rGUbg1uvGHaX8cx0nWwWDZMmudki1wiYitaU1RW8EoBaqmhJ4X+rs6ibToSI3PtBAn1QcaT+SUmIBj8+lqdo4pFglRVgxkFR8u2OoKqlXUur9ttTDzEpaOYlooGAM+Gws5+CCZN7L3aKM6ZXlNKThSExH0rhMIJ3T+Zi0j51wJJypnfpanuwQ1DE1CtHGEbqwj0B597jJt1cnWx4gbW8yauzgRYf2EcsyIACRbM8E4zbiJzFoNWZ24O1PRqleF9UDMiMPSKMCZepTsS2FkIiHDDppANMkh8UqZJYhXe59H8IDQ4cdLXkAVoEOK7eJEccWk9XPXkVA9Gw/WEVTpx//aicrbDhKNbxtFcgIVItsXPOqbCC3zmW5TE2hPGgD52tskD7iHCa7VkhzUEmuUKDO6fo+16FWe9B134CdtgrpOzp3eu4J3+Rx+5Ot4BjsFmgDQt2y+3jMTnFqOxN1fIkQ3pUV8SijhTOexS/o7aACvH6loAJ/vtR65RhjNDt7xVSiNRlvwUpiCSXSxDa2Es+vXlTUELXJph4+sRa2bCUz1fT1WUOzlxZRy7vSLdj8ndvpDrjkR7BEDl7217Y=
branches:
  only:
  - master
jobs:
  include:
  - stage: Tests
    name: API unit tests
    before_script:
    - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
      > ./cc-test-reporter
    - chmod +x ./cc-test-reporter
    - "./cc-test-reporter before-build"
    script:
    - bundle exec rake db:setup
    - bundle exec rake spec
    after_script:
    - "./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT"
  - stage: Deploy
    name: Deploy to VPS
    script:
    - openssl aes-256-cbc -k $DEPLOY_KEY -in config/deploy_id_rsa_enc_travis -d -a
      -out config/deploy_id_rsa
    - bundle exec cap production deploy
stages:
- Tests
- name: Deploy
  if: type != pull_request
